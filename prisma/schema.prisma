generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===================================
// USER & AUTHENTICATION
// ===================================

model User {
  id                 String      @id @default(cuid())
  email              String      @unique
  password           String
  emailVerified      DateTime?
  accountType        AccountType @default(INDIVIDUAL)
  planType           PlanType    @default(BASIC)
  billingCycle       String?     @default("MONTHLY")
  trialEndsAt        DateTime?
  subscriptionEndsAt DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  profile        Profile?
  invoices       Invoice[]
  customers      Customer[]
  bankAccounts   BankAccount[]
  templates      Template[]
  subscription   Subscription?
  wallet         Wallet?
  teamMembers    TeamMember[]    @relation("OwnedTeam")
  memberships    TeamMember[]    @relation("MemberOf")
  activities     Activity[]
  passwordResets PasswordReset[]

  @@index([email])
}

model Profile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessName String?
  firstName    String?
  lastName     String?
  phone        String?
  address      String?
  city         String?
  state        String?
  country      String  @default("Nigeria")
  postalCode   String?
  logo         String?
  taxId        String?
  logoUrl      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

// ===================================
// SUBSCRIPTION & PAYMENTS
// ===================================

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan               PlanType
  billingCycle       BillingCycle?
  status             SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  trialEndsAt        DateTime?
  cancelledAt        DateTime?
  gracePeriodEndsAt  DateTime?

  nombaCustomerId     String?
  nombaSubscriptionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments Payment[]

  @@index([userId])
  @@index([status])
}

model Payment {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  amount         Float
  currency       String        @default("NGN")
  status         PaymentStatus @default(PENDING)
  paymentMethod  String?
  nombaReference String?       @unique

  paidAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([subscriptionId])
  @@index([nombaReference])
}

// ===================================
// TEAM MANAGEMENT
// ===================================

model TeamMember {
  id       String @id @default(cuid())
  ownerId  String
  owner    User   @relation("OwnedTeam", fields: [ownerId], references: [id], onDelete: Cascade)
  memberId String
  member   User   @relation("MemberOf", fields: [memberId], references: [id], onDelete: Cascade)

  role        TeamRole         @default(EDITOR)
  permissions Json // {viewWallet: false, manageCustomers: true, etc.}
  status      TeamMemberStatus @default(PENDING)

  invitedAt    DateTime  @default(now())
  acceptedAt   DateTime?
  lastActiveAt DateTime?

  @@unique([ownerId, memberId])
  @@index([ownerId])
  @@index([memberId])
}

// ===================================
// CUSTOMER MANAGEMENT
// ===================================

model Customer {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name       String
  email      String
  phone      String?
  address    String?
  city       String?
  state      String?
  country    String?
  postalCode String?
  taxId      String?
  notes      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices Invoice[]

  @@index([userId])
  @@index([email])
}

// ===================================
// BANK ACCOUNTS & NOMBA
// ===================================

model BankAccount {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bankName      String
  accountNumber String
  accountName   String
  isDefault     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices Invoice[]

  @@index([userId])
}

model NombaAccount {
  id     String @id @default(cuid())
  userId String @unique

  accountNumber  String
  accountName    String
  bankName       String
  nombaAccountId String  @unique
  isActive       Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([nombaAccountId])
}

// ===================================
// INVOICES
// ===================================

model Invoice {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  customerId    String?
  customer      Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  bankAccountId String?
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)

  invoiceNumber String
  invoiceDate   DateTime @default(now())
  dueDate       DateTime

  billToName    String
  billToEmail   String
  billToPhone   String?
  billToAddress String?

  items InvoiceItem[]

  subtotal       Float
  taxRate        Float?        @default(0)
  taxAmount      Float?        @default(0)
  discountType   DiscountType?
  discountValue  Float?        @default(0)
  discountAmount Float?        @default(0)
  totalAmount    Float

  amountPaid Float         @default(0)
  balanceDue Float
  status     InvoiceStatus @default(DRAFT)

  hasPaymentSchedule Boolean            @default(false)
  paymentMilestones  PaymentMilestone[]

  paymentTerms  String?
  notes         String?
  templateId    String?
  template      Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  customization Json?

  sentAt     DateTime?
  viewedAt   DateTime?
  paidAt     DateTime?
  archivedAt DateTime?

  useNombaPayment  Boolean @default(false)
  nombaPaymentLink String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments   InvoicePayment[]
  activities Activity[]

  @@unique([userId, invoiceNumber])
  @@index([userId])
  @@index([customerId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([createdAt])
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description String
  quantity    Float
  unitPrice   Float
  amount      Float

  order     Int      @default(0)
  createdAt DateTime @default(now())

  @@index([invoiceId])
}

model PaymentMilestone {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  name       String
  amount     Float
  percentage Float?
  dueDate    DateTime
  status     MilestoneStatus @default(PENDING)
  paidAt     DateTime?

  order     Int      @default(0)
  createdAt DateTime @default(now())

  @@index([invoiceId])
}

model InvoicePayment {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  amount        Float
  paymentDate   DateTime @default(now())
  paymentMethod String?
  reference     String?
  notes         String?

  nombaReference String? @unique

  createdAt DateTime @default(now())

  @@index([invoiceId])
  @@index([nombaReference])
}

// ===================================
// WALLET (PRO ONLY)
// ===================================

model Wallet {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  balance       Float @default(0)
  totalReceived Float @default(0)
  totalPending  Float @default(0)

  updatedAt DateTime @updatedAt

  transactions WalletTransaction[]

  @@index([userId])
}

model WalletTransaction {
  id       String @id @default(cuid())
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  type        TransactionType
  amount      Float
  description String
  reference   String?

  createdAt DateTime @default(now())

  @@index([walletId])
  @@index([createdAt])
}

// ===================================
// TEMPLATES
// ===================================

model Template {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  isDefault Boolean @default(false)
  isPremium Boolean @default(false)
  thumbnail String?

  design Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices Invoice[]

  @@index([userId])
  @@index([isDefault])
  @@index([isPremium])
}

// ===================================
// ACTIVITY LOG
// ===================================

model Activity {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  action      String
  description String
  metadata    Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([invoiceId])
  @@index([createdAt])
}

// ===================================
// ENUMS
// ===================================

enum AccountType {
  INDIVIDUAL
  COMPANY
}

enum PlanType {
  BASIC
  PRO
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
  GRACE_PERIOD
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum TeamRole {
  ADMIN
  EDITOR
}

enum TeamMemberStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  UNPAID
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum MilestoneStatus {
  PENDING
  PAID
}

enum TransactionType {
  CREDIT
  DEBIT
}
